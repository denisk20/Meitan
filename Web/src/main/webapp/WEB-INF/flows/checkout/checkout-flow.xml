<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	  xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
	  parent="global">

    <!--todo unit test this-->

	<view-state id="checkout" model="cart">
        <transition on="delete">
            <evaluate expression="cart.deleteItem(cart.itemsDataModel.selectedRow)"/>
            <render fragments="checkout:quantityTable,checkout:cartItemsFragment,topPanelForm:shoppingCartFragment"/>
        </transition>
        
        <transition on="quantityChanged">
            <render fragments="checkout:cartItemsFragment,topPanelForm:shoppingCartFragment"/>
        </transition>

        <transition on="order" to="decideIfUserIsAuthenticated">
            <!--<secured attributes="ROLE_UNREGISTERED, ROLE_CLIENT, ROLE_CONSULTANT, ROLE_ADMIN" match="any"/>-->
        </transition>

        <transition on-exception="org.springframework.security.access.AccessDeniedException" to="error"/>
    </view-state>

	<action-state id="decideIfUserIsAuthenticated">
		<evaluate expression="securityService.isUserAuthenticated()"/>
		<transition on="yes" to="order"/>
		<transition on="no" to="quickRegistrationFirstTime">
			<evaluate expression="clientDao.newInstance()" result="flowScope.anonymousClient"/>
			<!--todo why do we get null in de-serialized Client's name?-->
			<!--<evaluate expression="clientDao.newInstance()" result="conversationScope.anonymousClient"/>-->
		</transition>
		<transition on="unregistered" to="changeQuickregDetails">
			<evaluate expression="clientDao.getByLogin(currentUser.name)" result="flowScope.anonymousClient"/>
		</transition>
	</action-state>

	<view-state id="changeQuickregDetails" model="anonymousClient">
		<transition on="change" to="quickRegistrationAdjustDetails"/>
		<transition on="itsOK" to="order"/>
	</view-state>

	<view-state id="quickRegistration" model="anonymousClient">
		<transition on="quickreg" to="order">
		</transition>
	</view-state>

	<view-state id="quickRegistrationFirstTime" parent="checkout#quickRegistration" view="../checkout/quickRegistration.xhtml">
		<transition on="quickreg" to="order">
			<set name="anonymousClient.login" value="anonymousClient.email"/>
			<evaluate expression="clientDao.saveOrFetchUnregisteredClientByEmail(anonymousClient)" result="flowScope.anonymousClient"/>
			<evaluate expression="securityService.authenticateUser(anonymousClient)"/>
		</transition>
	</view-state>

	<view-state id="quickRegistrationAdjustDetails" parent="checkout#quickRegistration" view="../checkout/quickRegistration.xhtml" model="anonymousClient">
		<transition on="quickreg" to="order">
			<set name="anonymousClient.login" value="anonymousClient.email"/>
			<evaluate expression="clientDao.mergeAnonymousClient(anonymousClient)"/>
			<evaluate expression="securityService.authenticateUser(anonymousClient)"/>
		</transition>
	</view-state>

	<view-state id="order">
        <transition on="order" to="success">
            <evaluate expression="clientDao.buyGoods(cart, currentUser.name)"/>
            <evaluate expression="mailService.sendBuyingActNotification(cart, currentUser)"/>
            <evaluate expression="cart.emptyCart()"/>
		</transition>
		<!--
		  <on-exit>
			  <evaluate expression="securityService.tryToLogoutAnonymous(currentUser.name)"/>
		  </on-exit>
  -->
    </view-state>

    <view-state id="success">
        <transition on="done" to="done"/>
    </view-state>

    <view-state id="error" view="externalRedirect:contextRelative:/spring/login"/>
    <view-state id="done" view="flowRedirect:about"/>
</flow>