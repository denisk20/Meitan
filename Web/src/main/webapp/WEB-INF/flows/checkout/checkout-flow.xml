<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
      parent="global">

    <!--todo unit test this-->

    <view-state id="checkout" model="cart">
        <transition on="delete" >
            <evaluate expression="cart.deleteItem(cart.itemsDataModel.selectedRow)"/>
            <render fragments="checkout:quantityTable,checkout:cartItemsFragment,topPanelForm:shoppingCartFragment"/>
        </transition>
        
        <transition on="quantityChanged">
            <render fragments="checkout:cartItemsFragment,topPanelForm:shoppingCartFragment"/>
        </transition>

        <transition on="order" to="order">
            <secured attributes="ROLE_CLIENT, ROLE_CONSULTANT, ROLE_ADMIN" match="any"/>
        </transition>

        <transition on-exception="org.springframework.security.access.AccessDeniedException" to="error"/>
    </view-state>

    <view-state id="order">
        <transition on="order" to="success" >
            <evaluate expression="clientDao.buyGoods(cart, currentUser.name)"/>
            <evaluate expression="mailService.sendBuyingActNotification(cart, currentUser)"/>
            <evaluate expression="cart.emptyCart()"/>
        </transition>
    </view-state>

    <view-state id="success">
        <transition on="done" to="done"/>
    </view-state>

    <view-state id="error" view="externalRedirect:contextRelative:/spring/login"/>
    <view-state id="done" view="flowRedirect:about"/>
</flow>